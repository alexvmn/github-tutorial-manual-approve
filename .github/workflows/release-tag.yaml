name: Release (tag) -> Deploy TEST -> PROD

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  ci:
    name: CI (lint + tests)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install deps
        run: uv sync --group dev

      - name: Lint
        run: uv run ruff check .

      - name: Tests
        run: uv run pytest -q

  build:
    name: Build artifact (from tag commit)
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
      git_sha: ${{ steps.meta.outputs.git_sha }}
      tag_name: ${{ steps.meta.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set build metadata
        id: meta
        run: |
          echo "git_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "tag_name=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "artifact_name=app-${GITHUB_SHA}.zip" >> $GITHUB_OUTPUT

          echo "GIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "BUILT_AT_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "RELEASE_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Create build folder
        run: |
          mkdir -p build
          cp -r app build/app
          printf "%s\n" "${GIT_SHA}" > build/GIT_SHA.txt
          printf "%s\n" "${BUILT_AT_UTC}" > build/BUILT_AT_UTC.txt
          printf "%s\n" "${RELEASE_TAG}" > build/RELEASE_TAG.txt

      - name: Zip artifact
        run: |
          cd build
          zip -r "../${{ steps.meta.outputs.artifact_name }}" .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_build
          path: ${{ steps.meta.outputs.artifact_name }}

  deploy_test:
    name: Deploy to TEST
    runs-on: ubuntu-latest
    needs: build
    environment: TEST
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release_build

      - name: Simulated deploy (TEST)
        run: |
          echo "Deploying tag ${{ needs.build.outputs.tag_name }} to TEST..."
          ls -lah
          echo "OK"

  deploy_prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy_test
    environment: PROD
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release_build

      - name: Simulated deploy (PROD)
        run: |
          echo "Deploying to PROD..."
          ls -lah
          echo "OK"
