name: CI/CD Pipeline

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci:
    name: CI (lint + tests)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install deps
        run: uv sync --group dev

      - name: Lint
        run: uv run ruff check .

      - name: Tests
        run: uv run pytest -q

  build:
    name: Build artifact
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name != 'pull_request'
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set build metadata
        id: meta
        run: |
          echo "GIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "BUILT_AT_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "artifact_name=app-${GITHUB_SHA}.zip" >> $GITHUB_OUTPUT

      - name: Create build folder
        run: |
          mkdir -p build
          cp -r app build/app
          printf "%s\n" "${GIT_SHA}" > build/GIT_SHA.txt
          printf "%s\n" "${BUILT_AT_UTC}" > build/BUILT_AT_UTC.txt

      - name: Zip artifact
        run: |
          cd build
          zip -r "../${{ steps.meta.outputs.artifact_name }}" .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ${{ steps.meta.outputs.artifact_name }}

  deploy_dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: build
    environment: DEV
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build

      - name: Simulated deploy (DEV)
        run: |
          echo "Deploying to DEV..."
          ls -lah
          echo "OK"

  deploy_stage:
    name: Deploy to STAGE
    runs-on: ubuntu-latest
    needs: deploy_dev
    environment: STAGE
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build

      - name: Simulated deploy (STAGE)
        run: |
          echo "Deploying to STAGE..."
          ls -lah
          echo "OK"

  deploy_prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy_stage
    environment: PROD
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build

      - name: Simulated deploy (PROD)
        run: |
          echo "Deploying to PROD..."
          ls -lah
          echo "OK"
